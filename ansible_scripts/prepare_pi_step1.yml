- hosts: pi
  become: yes
  vars:
    home: /home/admin
    
  tasks:

  - name: install/update bluez-compassion
    git:
      repo: 'https://github.com/ykasidit/bluez-compassion.git'
      dest: "{{ home }}/bluez-compassion"
      clone: yes
      update: yes

  - name: install/update bluez-gatt-server
    git:
      repo: 'https://github.com/ykasidit/bluez-gatt-server.git'
      dest: "{{ home }}/bluez-gatt-server"
      clone: yes
      update: yes

  - name: test bluez-gatt-server
    shell: cd "{{ home }}/bluez-gatt-server" && nose2

  - name: install micropygps
    git:
      repo: https://github.com/ykasidit/micropyGPS-python2.git
      dest: "{{ home }}/micropyGPS-python2"
      clone: yes
      update: yes

  - name: install ecodroidgps
    git:
      repo: https://gitlab.com/ykasidit/ecodroidgps_bin.git
      dest: "{{ home }}/ecodroidgps"
      clone: yes
      update: yes

  - name: ensure mount point dirs exist - test ecodroidgps would mount
    shell: sudo mkdir -p /config ; sudo mkdir -p /data

  - name: test ecodroidgps
    shell: cd "{{ home }}/ecodroidgps" && sudo nose2 -F --quiet

  - name: prepare bluetooth folder link in mounted dev to store pairing info
    shell: sudo mkdir -p /config/bluetooth && sudo rm -rf /var/lib/bluetooth && sudo ln -s /config/bluetooth /var/lib/bluetooth

  - name: install ecodroidgps service
    shell: cd "{{ home }}/ecodroidgps" && sudo ./install_service.sh

  - lineinfile:
      path: /etc/systemd/journald.conf
      regexp: '^Storage='
      line: 'Storage=volatile'

