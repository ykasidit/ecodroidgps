- hosts: pi
  become: yes
  vars:
    home: /home/pi
    bluez_url: http://www.kernel.org/pub/linux/bluetooth/bluez-5.50.tar.xz
    bluez_target_dir: "{{ home }}/bluez-5.50"
    
  tasks:

  - name: update, upgrade
    shell: sudo apt-get update && sudo apt-get -y upgrade
  
  - name: install apt packages
    shell: sudo apt-get install -y git bc libusb-dev libdbus-1-dev libglib2.0-dev libudev-dev libical-dev libreadline-dev

  - name: mkdir bluez_target_dir
    file:
      path: "{{ bluez_target_dir }}"
      state: directory
    
  - name: download and extract bluez src    
    unarchive:
      src: "{{ bluez_url }}"
      dest: "{{ home }}"
T      remote_src: yes

  - name: bluez configure make make install
    shell: "cd {{ bluez_target_dir }} && ./configure --prefix=/usr --mandir=/usr/share/man --sysconfdir=/etc --localstatedir=/var --disable-cups --disable-hid --disable-hog && make -j4 && sudo make install"
    args:
      executable: /bin/bash

  - lineinfile:
      path:  /etc/bluetooth/main.conf
      regexp: '^(#Name =|Name =)'
      line: Name = EcoDroidGPS Bluetooth GPS

  - lineinfile:
      path:  /lib/systemd/system/bluetooth.service
      regexp: '^ExecStart'
      line: ExecStart=/usr/libexec/bluetooth/bluetoothd --noplugin=wiimote,battery,hostname


  - name: bluetoothd binary link to new one, systemctl daemon-reload to reload/apply newly installed bluetooth.service that would use the compiled /usr/libexec/bluetooth/bluetoothd instead of the original /usr/lib/bluetooth/bluetoothd
    shell:  sudo cp /usr/lib/bluetooth/bluetoothd /usr/lib/bluetooth/bluetoothd-prev && sudo ln -sf /usr/libexec/bluetooth/bluetoothd /usr/lib/bluetooth/bluetoothd && systemctl daemon-reload && systemctl restart bluetooth

  - name: check bluetooth service active
    shell: systemctl is-active bluetooth

  - name: bluetoothd ver check
    shell: bluetoothd -v | grep 5.50
    args:
      executable: /bin/bash

  - name: bluetoothctl ver check
    shell: bluetoothctl -v | grep 5.50
    args:
      executable: /bin/bash

  - name: btmgmt check device present
    shell: btmgmt info | grep addr | grep class
    args:
      executable: /bin/bash

  - name: btmgmt check correct dev name applied
    shell: btmgmt info | grep 'name EcoDroidGPS Bluetooth GPS'
    args:
      executable: /bin/bash

